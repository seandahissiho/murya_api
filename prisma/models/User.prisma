model User {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstname         String?
  lastname          String?
  email             String?   @db.VarChar(255)
  phone             String?   @db.VarChar(30)
  deviceId          String?   @db.VarChar(255)
  password          String? // mot de passe haché
  isActive          Boolean   @default(true) // utilisateur actif ou non
  isAdmin           Boolean   @default(false) // utilisateur admin
  createdAt         DateTime  @default(now())
  lastLogin         DateTime? // date de dernière connexion
  avatarUrl         String?
  birthDate         DateTime?
  genre             Genre?    @default(UNDEFINED) // genre de l'utilisateur
  roleId            String    @db.Uuid // identifiant du rôle de l'utilisateur
  refreshToken      String? // token de rafraîchissement pour l'authentification
  addressId         String?   @db.Uuid // ID de l'adresse associée
  preferredLangCode String?   @db.VarChar(16)
  createdById       String?   @db.Uuid // identifiant de l'utilisateur qui a créé ce compte
  updatedById       String?   @db.Uuid // identifiant de l'utilisateur qui a mis à jour ce compte

  role                   Role                    @relation(fields: [roleId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_role_id")
  preferredLang          Language?               @relation(name: "UserPreferredLanguage", fields: [preferredLangCode], references: [code], onUpdate: Cascade, onDelete: SetNull)
  // utilisateur qui a créé ou mis à jour ce compte
  createdBy              User?                   @relation(name: "UserCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_created_by")
  updatedBy              User?                   @relation(name: "UserUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_updated_by")
  // notifications envoyées à cet utilisateur
  notificationRecipients NotificationRecipient[]
  // fichiers téléchargés par cet utilisateur
  uploadedFilesCreatedBy UploadedFile[]          @relation(name: "UploadedFileCreatedBy")
  uploadedFilesUpdatedBy UploadedFile[]          @relation(name: "UploadedFileUploadedBy")
  // adresse associée à cet utilisateur
  address                Address?                @relation(fields: [addressId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_address_id")
  // utilisateurs créés et mis à jour par cet utilisateur
  usersCreated           User[]                  @relation(name: "UserCreatedBy")
  usersUpdated           User[]                  @relation(name: "UserUpdatedBy")
  // pays créés et mis à jour par cet utilisateur
  countriesCreated       Country[]               @relation(name: "CountryCreatedBy")
  countriesUpdated       Country[]               @relation(name: "CountryUpdatedBy")
  // adresses créées et mises à jour par cet utilisateur
  addressesCreated       Address[]               @relation(name: "AddressCreatedBy")
  addressesUpdated       Address[]               @relation(name: "AddressUpdatedBy")
  // clients créés et mis à jour par cet utilisateur
  clientCompaniesCreated Company[]               @relation(name: "ClientCompanyCreatedBy")
  clientCompaniesUpdated Company[]               @relation(name: "ClientCompanyUpdatedBy")
  userJobs               UserJob[]

  @@unique([email], map: "unique_email_not_null")
  @@unique([phone], map: "unique_phone_not_null")
  @@unique([deviceId], map: "unique_device_not_null")
  @@index([preferredLangCode])
  // Partial unique indexes (PostgreSQL only)
  @@index([email])
  @@index([phone])
  @@index([deviceId])
}

model UserJob {
  id     String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String        @db.Uuid
  jobId  String        @db.Uuid
  status UserJobStatus @default(TARGET)
  // Optional: manual level or seniority (1–5 for example)
  level  Int?
  note   String?       @db.Text

  // Aggregated stats for fast dashboards (optional but useful)
  quizzesCount Int       @default(0)
  totalScore   Int       @default(0) // sum of all quiz totalScore
  maxScoreSum  Int       @default(0) // sum of all quiz maxScore
  lastQuizAt   DateTime? @db.Timestamp(0)

  createdAt DateTime @default(now()) @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(0)

  user User @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  userQuizzes UserQuiz[]

  @@unique([userId, jobId], map: "unique_user_job")
  @@index([userId], map: "idx_user_job_user")
  @@index([jobId], map: "idx_user_job_job")
}

model UserQuiz {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userJobId String @db.Uuid
  quizId    String @db.Uuid // Quiz.id is String @default(uuid())

  kind   UserQuizKind   @default(DAILY)
  status UserQuizStatus @default(ASSIGNED)

  assignedAt  DateTime  @default(now()) @db.Timestamp(0)
  startedAt   DateTime? @db.Timestamp(0)
  completedAt DateTime? @db.Timestamp(0)

  totalScore Int?   @default(0)
  maxScore   Int?   @default(0)
  percentage Float? @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(0)

  userJob UserJob @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  quiz    Quiz    @relation(fields: [quizId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  answers UserQuizAnswer[]

  @@index([userJobId], map: "idx_user_quiz_user_job")
  @@index([quizId], map: "idx_user_quiz_quiz")
}

model UserQuizAnswer {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userQuizId String @db.Uuid
  questionId String @db.Uuid // QuizQuestion.id (String)

  freeTextAnswer String?

  isCorrect Boolean? // set after correction
  score     Int?     @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(0)

  userQuiz UserQuiz               @relation(fields: [userQuizId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  question QuizQuestion           @relation(fields: [questionId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  options  UserQuizAnswerOption[]

  @@index([userQuizId], map: "idx_user_quiz_answer_user_quiz")
  @@index([questionId], map: "idx_user_quiz_answer_question")
}

model UserQuizAnswerOption {
  userQuizAnswerId String @db.Uuid
  responseId       String @db.Uuid // QuizResponse.id

  answer   UserQuizAnswer @relation(fields: [userQuizAnswerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  response QuizResponse   @relation(fields: [responseId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@id([userQuizAnswerId, responseId])
  @@index([responseId], map: "idx_user_quiz_answer_option_response")
}
