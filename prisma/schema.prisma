// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL") // direct (migrations)
  extensions = [pgcrypto] // or [uuid‑ossp]
}

enum permissions_action {
  CREATE
  READ
  UPDATE
  DELETE
}

enum permissions_entity {
  USER
}

enum NotificationCategory {
  SYSTEM
  USER
  PAYMENT
  PURCHASE
  SALE
  HR
  MARKETING
  FINANCE
  ADMINISTRATION
  LEGAL
  SUPPORT
  SECURITY
  MAINTENANCE
  REPORT
  ALERT
  EVENT
  REMINDER
  FEEDBACK
  OTHER
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum Genre {
  MALE
  FEMALE
  UNDEFINED
}

enum CompetencyType {
  // savoir-faire
  HARD_SKILL
  // savoir-être
  SOFT_SKILL
}

enum Level {
  EASY
  MEDIUM
  HARD
  EXPERT
  MIX
}

enum CompetencyRating {
  TRES_BON
  BON
  MOYEN
  MAUVAIS
  TRES_MAUVAIS
}

enum QuizQuestionType {
  single_choice
  multiple_choice
  true_false
  short_answer
  fill_in_the_blank
}

enum UserJobStatus {
  TARGET // a job the user is preparing for
  CURRENT // job they currently have
  PAST // job they had in the past
}

enum UserJobScope {
  JOB
  JOB_FAMILY
}

enum LeagueTier {
  IRON // Fer
  BRONZE // Bronze
  SILVER // Argent
  GOLD // Or
  PLATINUM // Platine
  EMERALD // Émeraude
  DIAMOND // Diamant
  MASTER // Maître
  GRANDMASTER // Grand Maître
  CHALLENGER // Challenger
}

enum JobProgressionLevel {
  BEGINNER
  JUNIOR
  MIDLEVEL
  SENIOR
}

enum UserQuizStatus {
  ASSIGNED
  STARTED
  COMPLETED
  EXPIRED
}

enum QuizType {
  POSITIONING
  DAILY
}

enum StreakType {
  LOGIN_DAILY
}

enum QuestPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ONCE
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  CLAIMED
  EXPIRED
}

enum QuestScope {
  USER
  USER_JOB
}

enum CurrencyType {
  DIAMONDS
  LEAGUE_POINTS
}

enum RewardKind {
  CINEMA
  CONCERT
  THEATRE
  SPORTS
  THEME_PARK
  OTHER
}

enum RewardFulfillmentMode {
  LOCAL
  EXTERNAL
}

enum RewardRedeemMethod {
  NONE
  CODE
  QR_CODE
  LINK
}

enum RewardPurchaseStatus {
  CONFIRMED
  FULFILLING
  READY
  REDEEMED
  CANCELLED
  REFUNDED
  FAILED
  EXPIRED
}

enum QuestCategory {
  MAIN
  BRANCH
  COLLECTION
  SHARE
}

enum LearningResourceType {
  ARTICLE
  PODCAST
  VIDEO
}

enum LearningResourceScope {
  JOB_DEFAULT // Ressource par défaut liée au Job (visible pour tous les UserJob du job)
  USER_JOB // Ressource personnalisée pour un UserJob précis
}

enum LearningResourceSource {
  SYSTEM_DEFAULT // créée à la main / seed
  AI_GENERATED // générée par l'IA
  EXTERNAL_LINK // lien externe (YouTube, podcast hébergé ailleurs, etc.)
}

enum ModuleStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ModuleVisibility {
  PUBLIC
  PRIVATE
  RESTRICTED
}

enum UserModuleStatus {
  ACTIVE
  INACTIVE
  HIDDEN
}

enum LandingModuleAddedBy {
  SYSTEM
  USER
}

enum LandingModuleAction {
  ADD
  REMOVE
}

enum LandingModuleActor {
  SYSTEM
  USER
}

model Address {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ref           String    @unique
  name          String?   @unique
  shortName     String?
  street        String
  zip           String?
  city          String
  countryId     String // ← Foreign key column
  status        Int       @default(1) // 1 = actif, 0 = inactif
  isVirtual     Boolean?  @default(false) // false = interne, true = externe
  googleMapsUrl String?   @db.VarChar(700)
  googlePlaceId String?   @db.VarChar(128)
  latitude      Float?
  longitude     Float?
  createdAt     DateTime  @default(now()) @db.Timestamp(0)
  updatedAt     DateTime  @default(now()) @updatedAt @db.Timestamp(0)
  createdById   String?   @db.Uuid // identifiant de l'utilisateur qui a créé cette adresse
  updatedById   String?   @db.Uuid // identifiant de l'utilisateur qui a mis à jour cette adresse
  // Metadata for auditing
  // Relations
  country       Country   @relation(fields: [countryId], references: [isoCode], onUpdate: Cascade, onDelete: NoAction) // ← Relation to Country model
  companies     Company[] // Entreprises associées à cette adresse
  users         User[] // Utilisateurs associés à cette adresse
  rewards       Reward[]
  createdBy     User?     @relation(name: "AddressCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_addresses_created_by")
  updatedBy     User?     @relation(name: "AddressUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_addresses_updated_by")

  @@unique([street, zip, city, countryId], map: "unique_address")
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actorUserId String?  @db.Uuid
  actorRoleId String?  @db.Uuid
  isAdmin     Boolean? @db.Boolean
  method      String   @db.VarChar(8)
  path        String   @db.VarChar(512)
  route       String?  @db.VarChar(255)
  statusCode  Int
  durationMs  Int?
  ip          String?  @db.VarChar(64)
  userAgent   String?  @db.VarChar(512)
  params      Json?
  query       Json?
  createdAt   DateTime @default(now()) @db.Timestamp(0)
  actorUser   User?    @relation(fields: [actorUserId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  @@index([actorUserId, createdAt], map: "idx_audit_log_actor_created_at")
  @@index([createdAt], map: "idx_audit_log_created_at")
  @@index([route], map: "idx_audit_log_route")
}

model Company {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String        @unique(map: "company_name") @db.VarChar(255)
  nameShort   String?       @db.VarChar(50) // nom court de l'entreprise
  logoUrl     String?       @db.VarChar(255) // URL du logo de
  email       String?       @unique(map: "company_email") @db.VarChar(255) // email unique pour les entreprises
  phone       String?       @db.VarChar(50) // téléphone de l'entreprise
  phone2      String?       @db.VarChar(50) // téléphone secondaire de l'entreprise
  phone3      String?       @db.VarChar(50) // téléphone tertiaire
  website     String?       @db.VarChar(255) // site web de l'entreprise
  siret       String?       @unique(map: "company_siret") @db.VarChar(14) // SIRET de l'entreprise
  siretValid  Boolean?      @default(false) // true si le SIRET est valide
  ifu         String?       @unique(map: "company_ifu") @db.VarChar(13) // Identifiant fiscal unique
  emcfNumber  String?       @unique(map: "company_emcf_number") @db.VarChar(20) // Numéro EMCF (si applicable)
  description String?       @db.Text
  addressId   String?       @db.Uuid // ID de l'adresse associée
  createdById String        @db.Uuid // ID de l'utilisateur qui a créé l'entreprise
  updatedById String?       @db.Uuid // ID de l'utilisateur qui a mis à jour l'entreprise
  createdAt   DateTime      @default(now()) @db.Timestamp(0)
  updatedAt   DateTime      @default(now()) @updatedAt @db.Timestamp(0)
  isCompany   Boolean       @default(true) // true = entreprise, false = personne physique
  isClient    Boolean       @default(true) // true = client, false = not a client
  address     Address?      @relation(fields: [addressId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_companies_address_id")
  createdBy   User          @relation(name: "ClientCompanyCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_companies_created_by")
  updatedBy   User?         @relation(name: "ClientCompanyUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_companies_updated_by")
  users       CompanyUser[]
}

model CompanyUser {
  companyId String  @db.Uuid
  userId    String  @db.Uuid
  role      String? @db.VarChar(64) // "ADMIN", "MEMBER", ...
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([companyId, userId])
  @@index([userId])
}

model CompetenciesFamily {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String                  @unique(map: "competencies_family_name") @db.VarChar(255)
  slug           String                  @unique @db.VarChar(255)
  description    String?                 @db.Text
  createdAt      DateTime                @default(now()) @db.Timestamp(0)
  updatedAt      DateTime                @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  subFamilies    CompetenciesSubFamily[]
  competencies   Competency[]            @relation("CompetencyFamilies")
  jobs           Job[]                   @relation("JobCompetenciesFamilies")
  kiviats        JobKiviat[]
  userJobKiviats UserJobKiviat[]
}

model CompetenciesSubFamily {
  id                       String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                     String                   @db.VarChar(255)
  slug                     String                   @unique @db.VarChar(255)
  description              String?                  @db.Text
  familyId                 String                   @db.Uuid
  createdAt                DateTime                 @default(now()) @db.Timestamp(0)
  updatedAt                DateTime                 @default(now()) @updatedAt @db.Timestamp(0)
  // Famille parente
  family                   CompetenciesFamily       @relation(fields: [familyId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_competencies_subfamily_family_id")
  // Relations métier
  competencies             Competency[]             @relation("CompetenciesSubFamilies")
  jobs                     Job[]                    @relation("JobCompetenciesSubfamilies")
  jobSubfamilyCompetencies JobSubfamilyCompetency[]

  // Unicité dans le scope d'une famille
  @@unique([familyId, name], map: "uq_subfamily_family_name")
}

model Competency {
  id                       String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                     String                   @db.VarChar(255)
  slug                     String                   @unique @db.VarChar(255)
  description              String?                  @db.Text
  type                     CompetencyType
  level                    Level                    @default(EASY)
  createdAt                DateTime                 @default(now()) @db.Timestamp(0)
  updatedAt                DateTime                 @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  jobs                     Job[]                    @relation("JobCompetencies")
  families                 CompetenciesFamily[]     @relation("CompetencyFamilies")
  subFamilies              CompetenciesSubFamily[]  @relation("CompetenciesSubFamilies")
  quizQuestions            QuizQuestion[]           @relation("CompetencyQuizQuestions")
  userJobCompetencies      UserJobCompetency[]
  jobSubfamilyCompetencies JobSubfamilyCompetency[]

  @@index([name], map: "idx_competency_name")
}

model Country {
  // id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  isoCode     String    @id @unique // Code ISO du pays (optionnel)
  iso3Code    String?   @unique // Code ISO3 du pays (optionnel)
  phoneCode   String?   @unique // Indicatif téléphonique du pays (optionnel)
  createdAt   DateTime  @default(now()) @db.Timestamp(0)
  updatedAt   DateTime  @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  addresses   Address[] // Adresses associées à ce pays
  createdById String?   @db.Uuid // ID de l'utilisateur qui a créé le pays
  updatedById String?   @db.Uuid // ID de l'utilisateur qui a mis à jour le pays
  createdBy   User?     @relation(name: "CountryCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_countries_created_by")
  updatedBy   User?     @relation(name: "CountryUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_countries_updated_by")

  @@index([name], map: "idx_countries_name")
}

model CurrencyLedger {
  id        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String       @db.Uuid
  currency  CurrencyType
  delta     Int
  reason    String       @db.VarChar(120)
  refType   String       @db.VarChar(60)
  refId     String       @db.Uuid
  createdAt DateTime     @default(now()) @db.Timestamp(0)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([currency, refType, refId])
  @@index([userId, createdAt])
}

model Job {
  id                       String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobFamilyId              String?                  @db.Uuid
  title                    String                   @db.VarChar(255)
  slug                     String                   @unique @db.VarChar(255)
  description              String?                  @db.Text
  createdAt                DateTime                 @default(now()) @db.Timestamp(0)
  updatedAt                DateTime                 @default(now()) @updatedAt @db.Timestamp(0)
  isActive                 Boolean                  @default(true)
  popularity               Int                      @default(0)
  backgroundColor          String                   @default("#FFFFFFFF") @db.VarChar(9)
  foregroundColor          String                   @default("#FFFFFFFF") @db.VarChar(9)
  textColor                String                   @default("#FFFFFFFF") @db.VarChar(9)
  overlayColor             String                   @default("#FFFFFFFF") @db.VarChar(9)
  imageIndex               Int                      @default(0)
  quizzes                  Quiz[]                   @relation("JobQuizzes")
  // Relations
  jobFamily                JobFamily?               @relation(fields: [jobFamilyId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_jobs_job_family_id")
  competencies             Competency[]             @relation("JobCompetencies")
  competenciesFamilies     CompetenciesFamily[]     @relation("JobCompetenciesFamilies")
  competenciesSubfamilies  CompetenciesSubFamily[]  @relation("JobCompetenciesSubfamilies")
  userJobs                 UserJob[]
  userJobSelections        UserJobSelectedJob[]
  learningResources        LearningResource[]
  jobSubfamilyCompetencies JobSubfamilyCompetency[]
  kiviats                  JobKiviat[]

  @@index([jobFamilyId])
}

model JobFamily {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String             @unique(map: "job_family_name") @db.VarChar(255)
  slug              String             @unique @db.VarChar(255)
  description       String?            @db.Text
  createdAt         DateTime           @default(now()) @db.Timestamp(0)
  updatedAt         DateTime           @default(now()) @updatedAt @db.Timestamp(0)
  jobs              Job[]
  userJobs          UserJob[]
  learningResources LearningResource[]
  quizzes           Quiz[]
}

model JobKiviat {
  id                   String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId                String              @db.Uuid
  competenciesFamilyId String              @db.Uuid
  level                JobProgressionLevel
  rawScore0to10        Float               @default(0)
  radarScore0to5       Float               @default(0)
  continuous0to10      Float               @default(0)
  masteryAvg0to1       Float               @default(0)
  updatedAt            DateTime            @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  job                  Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "FK_job_kiviat_job_id")
  competenciesFamily   CompetenciesFamily  @relation(fields: [competenciesFamilyId], references: [id], onDelete: Cascade, onUpdate: Cascade, map: "FK_job_kiviat_family_id")

  @@unique([jobId, competenciesFamilyId, level], map: "UQ_job_kiviat_job_family_level")
  @@index([jobId], map: "IDX_job_kiviat_job_id")
  @@index([competenciesFamilyId], map: "IDX_job_kiviat_family_id")
}

model JobSubfamilyCompetency {
  jobId        String                @db.Uuid
  subFamilyId  String                @db.Uuid
  competencyId String                @db.Uuid
  job          Job                   @relation(fields: [jobId], references: [id])
  subFamily    CompetenciesSubFamily @relation(fields: [subFamilyId], references: [id])
  competency   Competency            @relation(fields: [competencyId], references: [id])

  @@id([jobId, subFamilyId, competencyId])
  // Interdit une compétence dans 2 sous-familles pour un même job :
  @@unique([jobId, competencyId])
}

model Language {
  code           String  @id @db.VarChar(16) // ex: "en", "fr", "fr-FR"
  name           String
  isDefault      Boolean @default(false)
  usersPreferred User[]  @relation("UserPreferredLanguage")
}

model LearningResource {
  id                    String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  // Scope & typage
  scope                 LearningResourceScope  @default(USER_JOB)
  type                  LearningResourceType   @default(ARTICLE)
  source                LearningResourceSource @default(AI_GENERATED)
  // Liens métier
  jobId                 String?                @db.Uuid // pour les ressources par défaut (et/ou redondance pour les ressources user)
  jobFamilyId           String?                @db.Uuid // pour les ressources par défaut d'une famille de métiers
  userJobId             String?                @db.Uuid // pour les ressources personnalisées
  // Contenu
  title                 String                 @db.VarChar(255)
  slug                  String?                @unique @db.VarChar(255)
  description           String?                @db.Text
  content               String?                @db.Text // article, script de podcast, transcript de vidéo, etc.
  mediaUrl              String?                @db.VarChar(1024) // URL audio/vidéo si besoin
  thumbnailUrl          String?                @db.VarChar(1024)
  languageCode          String?                @db.VarChar(16)
  estimatedDuration     Int? // en secondes
  metadata              Json? // pour stocker n’importe quel extra (IDs IA, tags, etc.)
  // Audit
  createdAt             DateTime               @default(now()) @db.Timestamp(0)
  updatedAt             DateTime               @default(now()) @updatedAt @db.Timestamp(0)
  collectedAt           DateTime?              @db.Timestamp(0)
  createdById           String?                @db.Uuid
  updatedById           String?                @db.Uuid
  // Relations
  job                   Job?                   @relation(fields: [jobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  jobFamily             JobFamily?             @relation(fields: [jobFamilyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userJob               UserJob?               @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  createdBy             User?                  @relation(name: "LearningResourceCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  updatedBy             User?                  @relation(name: "LearningResourceUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: SetNull)
  userLearningResources UserLearningResource[]

  @@index([jobId], map: "idx_learning_resource_job")
  @@index([jobFamilyId], map: "idx_learning_resource_job_family")
  @@index([userJobId], map: "idx_learning_resource_user_job")
  @@index([scope, type], map: "idx_learning_resource_scope_type")
}

model Module {
  id               String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug             String                   @unique @db.VarChar(255)
  name             String                   @db.VarChar(255)
  description      String?                  @db.Text
  status           ModuleStatus             @default(ACTIVE)
  visibility       ModuleVisibility         @default(PUBLIC)
  defaultOnLanding Boolean                  @default(false)
  createdAt        DateTime                 @default(now()) @db.Timestamp(0)
  updatedAt        DateTime                 @default(now()) @updatedAt @db.Timestamp(0)
  userModules      UserModule[]
  landingModules   UserLandingModule[]
  landingEvents    UserLandingModuleEvent[]

  @@index([status], map: "idx_module_status")
  @@index([visibility], map: "idx_module_visibility")
}

model Notification {
  id                     String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title                  String                  @db.VarChar(255)
  content                String?                 @db.Text
  is_important           Boolean                 @default(false) @db.Boolean
  category               NotificationCategory    @default(OTHER)
  createdAt              DateTime                @default(now()) @db.Timestamp(0)
  updatedAt              DateTime                @default(now()) @updatedAt @db.Timestamp(0)
  notificationRecipients NotificationRecipient[]
}

model NotificationRecipient {
  notificationId String       @db.Uuid
  userId         String       @db.Uuid
  notification   Notification @relation(fields: [notificationId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "notifications_recipients_ibfk_1")
  user           User         @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "notifications_recipients_ibfk_2")
  is_read        Boolean      @default(false) @db.Boolean

  @@id([notificationId, userId])
  @@index([userId], map: "userId")
}

model NotificationTemplate {
  id        String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key       String               @unique @db.VarChar(255) // e.g. "USER.WELCOME"
  category  NotificationCategory @default(OTHER)
  type      NotificationType     @default(INFO)
  createdAt DateTime             @default(now()) @db.Timestamp(0)
  updatedAt DateTime             @default(now()) @updatedAt @db.Timestamp(0)
}

model Permissions {
  id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId    String?            @db.Uuid
  entity    permissions_entity
  action    permissions_action
  createdAt DateTime           @default(now()) @db.Timestamp(0)
  updatedAt DateTime           @default(now()) @updatedAt @db.Timestamp(0)
  role      Role?              @relation(fields: [roleId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "permissions_role_id_foreign")

  @@unique([roleId, action, entity], map: "unique_role_action_entity")
  @@index([roleId], map: "permissions_role_id_index")
}

model QuestDefinition {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String            @unique @db.VarChar(80)
  title         String            @db.VarChar(160)
  description   String?           @db.Text
  period        QuestPeriod
  category      QuestCategory     @default(BRANCH)
  scope         QuestScope        @default(USER_JOB)
  eventKey      String            @db.VarChar(80)
  targetCount   Int               @default(1)
  meta          Json?
  isActive      Boolean           @default(true)
  parentId      String?           @db.Uuid
  parent        QuestDefinition?  @relation("QuestBranches", fields: [parentId], references: [id])
  branches      QuestDefinition[] @relation("QuestBranches")
  uiOrder       Int               @default(0)
  createdAt     DateTime          @default(now()) @db.Timestamp(0)
  updatedAt     DateTime          @default(now()) @updatedAt @db.Timestamp(0)
  rewards       QuestReward[]
  userJobQuests UserJobQuest[]
  userQuests    UserQuest[]
  questGroups   QuestGroupItem[]

  @@index([isActive, period])
  @@index([parentId])
}

model QuestGroup {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String           @unique @db.VarChar(80)
  title       String           @db.VarChar(160)
  description String?          @db.Text
  scope       QuestScope       @default(USER_JOB)
  period      QuestPeriod      @default(MONTHLY)
  meta        Json?
  isActive    Boolean          @default(true)
  uiOrder     Int              @default(0)
  createdAt   DateTime         @default(now()) @db.Timestamp(0)
  updatedAt   DateTime         @default(now()) @updatedAt @db.Timestamp(0)
  items       QuestGroupItem[]
  userGroups  UserQuestGroup[]

  @@index([isActive])
}

model QuestGroupItem {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  questGroupId      String          @db.Uuid
  questDefinitionId String          @db.Uuid
  isRequired        Boolean         @default(true)
  uiOrder           Int             @default(0)
  questGroup        QuestGroup      @relation(fields: [questGroupId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  questDefinition   QuestDefinition @relation(fields: [questDefinitionId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([questGroupId, questDefinitionId])
  @@index([questGroupId])
  @@index([questDefinitionId])
}

model QuestReward {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  questDefinitionId String          @db.Uuid
  currency          CurrencyType
  amount            Int             @default(0)
  createdAt         DateTime        @default(now()) @db.Timestamp(0)
  questDefinition   QuestDefinition @relation(fields: [questDefinitionId], references: [id], onDelete: Cascade)

  @@index([questDefinitionId])
}

model Quiz {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId       String?    @db.Uuid
  jobFamilyId String?    @db.Uuid
  title       String?
  description String?
  level       Level      @default(EASY)
  type        QuizType   @default(POSITIONING)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now()) @db.Timestamp(0)
  updatedAt   DateTime   @updatedAt @db.Timestamp(0)
  items       QuizItem[]
  job         Job?       @relation("JobQuizzes", fields: [jobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  jobFamily   JobFamily? @relation(fields: [jobFamilyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  quizzes     UserQuiz[]
}

model QuizItem {
  quizId             String       @db.Uuid
  questionId         String       @db.Uuid
  index              Int
  pointsOverride     Int?
  timeLimitOverrideS Int?
  createdAt          DateTime     @default(now()) @db.Timestamp(0)
  quiz               Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  question           QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@id([quizId, questionId])
  @@unique([quizId, index])
  @@index([questionId])
}

model QuizQuestion {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  competencyId      String           @db.Uuid
  text              String
  level             Level
  type              QuizQuestionType @default(single_choice)
  mediaUrl          String           @default("")
  metadata          Json?
  createdAt         DateTime         @default(now()) @db.Timestamp(0)
  updatedAt         DateTime         @updatedAt @db.Timestamp(0)
  defaultTimeLimitS Int              @default(30)
  defaultPoints     Int              @default(1)
  irtB              Float            @default(0)
  irtA              Float            @default(1)
  irtC              Float            @default(0)
  calibratedAt      DateTime?        @db.Timestamp(0)
  exposureCount     Int              @default(0)
  isBankActive      Boolean          @default(true)
  userAnswers       UserQuizAnswer[]
  competency        Competency       @relation("CompetencyQuizQuestions", fields: [competencyId], references: [id])
  responses         QuizResponse[]
  items             QuizItem[]

  @@index([competencyId])
}

model QuizResponse {
  id            String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  questionId    String                 @db.Uuid
  text          String
  metadata      Json?
  isCorrect     Boolean                @default(false)
  index         Int                    @default(0)
  createdAt     DateTime               @default(now()) @db.Timestamp(0)
  updatedAt     DateTime               @updatedAt @db.Timestamp(0)
  // Relations
  question      QuizQuestion           @relation(fields: [questionId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  answerOptions UserQuizAnswerOption[]

  @@index([questionId])
}

model Reward {
  id                 String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code               String                @unique @db.VarChar(80)
  title              String                @db.VarChar(160)
  description        String?               @db.Text
  kind               RewardKind            @default(OTHER)
  city               String                @db.VarChar(120)
  imageUrl           String                @db.VarChar(500)
  addressId          String?               @db.Uuid
  address            Address?              @relation(fields: [addressId], references: [id], onUpdate: Cascade, onDelete: SetNull)
  costDiamonds       Int                   @default(0)
  totalStock         Int?
  remainingStock     Int                   @default(0)
  isActive           Boolean               @default(true)
  visibleFrom        DateTime?             @db.Timestamp(0)
  visibleTo          DateTime?             @db.Timestamp(0)
  fulfillmentMode    RewardFulfillmentMode @default(LOCAL)
  providerKey        String?               @db.VarChar(80)
  externalProductId  String?               @db.VarChar(120)
  redeemMethod       RewardRedeemMethod    @default(CODE)
  redeemInstructions String?               @db.Text
  meta               Json?
  createdAt          DateTime              @default(now()) @db.Timestamp(0)
  updatedAt          DateTime              @default(now()) @updatedAt @db.Timestamp(0)
  purchases          RewardPurchase[]

  @@index([isActive, city])
  @@index([kind])
  @@index([remainingStock])
  @@index([addressId])
}

model RewardPurchase {
  id                String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String               @db.Uuid
  rewardId          String               @db.Uuid
  quantity          Int                  @default(1)
  unitCostDiamonds  Int
  totalCostDiamonds Int
  status            RewardPurchaseStatus @default(CONFIRMED)
  idempotencyKey    String               @db.VarChar(80)
  voucherCode       String?              @db.VarChar(120)
  voucherQrPayload  String?              @db.Text
  voucherLink       String?              @db.VarChar(700)
  externalOrderId   String?              @db.VarChar(160)
  providerRaw       Json?
  purchasedAt       DateTime             @default(now()) @db.Timestamp(0)
  readyAt           DateTime?            @db.Timestamp(0)
  redeemedAt        DateTime?            @db.Timestamp(0)
  cancelledAt       DateTime?            @db.Timestamp(0)
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward            Reward               @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@unique([userId, idempotencyKey])
  @@index([userId, purchasedAt])
  @@index([rewardId, purchasedAt])
  @@index([status])
}

model Role {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String        @unique(map: "role_name") @db.VarChar(255)
  createdAt   DateTime      @default(now()) @db.Timestamp(0)
  updatedAt   DateTime      @default(now()) @updatedAt @db.Timestamp(0)
  permissions Permissions[]
  users       User[]
}

model Translation {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entity    String   @db.VarChar(64) // "Job", "JobFamily", "Competency", etc.
  entityId  String   @db.Uuid
  field     String   @db.VarChar(64) // "title", "description", ...
  langCode  String   @db.VarChar(16) // "fr", "en"
  value     String   @db.Text
  createdAt DateTime @default(now()) @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(0)

  @@unique([entity, entityId, field, langCode], map: "unique_translation_row")
  @@index([langCode], map: "idx_translation_lang")
  @@index([entity, field], map: "idx_translation_entity_field")
}

model UploadedFile {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdById String?  @db.Uuid
  updatedById String?  @db.Uuid
  file_name   String?  @db.VarChar(255)
  file_url    String   @db.VarChar(1024)
  mimeType    String   @db.VarChar(128)
  size        Int // size in bytes
  createdAt   DateTime @default(now()) @db.Timestamp(0)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  createdBy   User?    @relation(name: "UploadedFileCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_uploaded_files_created_by_id")
  updatedBy   User?    @relation(name: "UploadedFileUploadedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_uploaded_files_updated_by_id")

  @@index([createdById], map: "uploaded_files_created_by_id_index")
  @@index([updatedById], map: "uploaded_files_updated_by_id_index")
}

model User {
  id                         String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstname                  String?
  lastname                   String?
  email                      String?                  @db.VarChar(255)
  phone                      String?                  @db.VarChar(30)
  deviceId                   String?                  @db.VarChar(255)
  password                   String? // mot de passe haché
  diamonds                   Int                      @default(0) // nombre de diamants de l'utilisateur
  isActive                   Boolean                  @default(true) // utilisateur actif ou non
  isAdmin                    Boolean                  @default(false) // utilisateur admin
  createdAt                  DateTime                 @default(now()) @db.Timestamp(0)
  updatedAt                  DateTime                 @default(now()) @updatedAt @db.Timestamp(0)
  lastLogin                  DateTime?                @db.Timestamp(0) // date de dernière connexion
  avatarUrl                  String?
  birthDate                  DateTime?                @db.Timestamp(0)
  genre                      Genre?                   @default(UNDEFINED) // genre de l'utilisateur
  roleId                     String                   @db.Uuid // identifiant du rôle de l'utilisateur
  refreshToken               String? // token de rafraîchissement pour l'authentification
  addressId                  String?                  @db.Uuid // ID de l'adresse associée
  preferredLangCode          String?                  @db.VarChar(16)
  createdById                String?                  @db.Uuid // identifiant de l'utilisateur qui a créé ce compte
  updatedById                String?                  @db.Uuid // identifiant de l'utilisateur qui a mis à jour ce compte
  role                       Role                     @relation(fields: [roleId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_role_id")
  preferredLang              Language?                @relation(name: "UserPreferredLanguage", fields: [preferredLangCode], references: [code], onUpdate: Cascade, onDelete: SetNull)
  // utilisateur qui a créé ou mis à jour ce compte
  createdBy                  User?                    @relation(name: "UserCreatedBy", fields: [createdById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_created_by")
  updatedBy                  User?                    @relation(name: "UserUpdatedBy", fields: [updatedById], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_updated_by")
  // notifications envoyées à cet utilisateur
  notificationRecipients     NotificationRecipient[]
  // fichiers téléchargés par cet utilisateur
  uploadedFilesCreatedBy     UploadedFile[]           @relation(name: "UploadedFileCreatedBy")
  uploadedFilesUpdatedBy     UploadedFile[]           @relation(name: "UploadedFileUploadedBy")
  // adresse associée à cet utilisateur
  address                    Address?                 @relation(fields: [addressId], references: [id], onUpdate: Cascade, onDelete: NoAction, map: "FK_users_address_id")
  // utilisateurs créés et mis à jour par cet utilisateur
  usersCreated               User[]                   @relation(name: "UserCreatedBy")
  usersUpdated               User[]                   @relation(name: "UserUpdatedBy")
  // pays créés et mis à jour par cet utilisateur
  countriesCreated           Country[]                @relation(name: "CountryCreatedBy")
  countriesUpdated           Country[]                @relation(name: "CountryUpdatedBy")
  // adresses créées et mises à jour par cet utilisateur
  addressesCreated           Address[]                @relation(name: "AddressCreatedBy")
  addressesUpdated           Address[]                @relation(name: "AddressUpdatedBy")
  // clients créés et mis à jour par cet utilisateur
  clientCompaniesCreated     Company[]                @relation(name: "ClientCompanyCreatedBy")
  clientCompaniesUpdated     Company[]                @relation(name: "ClientCompanyUpdatedBy")
  userJobs                   UserJob[]
  // ressources d'apprentissage créées et mises à jour par cet utilisateur
  learningResourcesCreatedBy LearningResource[]       @relation(name: "LearningResourceCreatedBy")
  learningResourcesUpdatedBy LearningResource[]       @relation(name: "LearningResourceUpdatedBy")
  userLearningResources      UserLearningResource[]
  companies                  CompanyUser[]
  userModules                UserModule[]
  userLandingModules         UserLandingModule[]
  userLandingModuleEvents    UserLandingModuleEvent[]
  userStreaks                UserStreak[]
  currencyLedgers            CurrencyLedger[]
  rewardPurchases            RewardPurchase[]
  userQuests                 UserQuest[]
  userQuestGroups            UserQuestGroup[]
  auditLogs                  AuditLog[]

  @@unique([email], map: "unique_email_not_null")
  @@unique([phone], map: "unique_phone_not_null")
  @@unique([deviceId], map: "unique_device_not_null")
  @@index([preferredLangCode])
}

model UserJob {
  id                String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String                 @db.Uuid
  scope             UserJobScope           @default(JOB)
  jobId             String?                @db.Uuid
  jobFamilyId       String?                @db.Uuid
  status            UserJobStatus          @default(TARGET)
  // Optional: manual level or seniority (1–5 for example)
  note              String?                @db.Text
  // Aggregated stats for fast dashboards (optional but useful)
  totalScore        Int                    @default(0) // sum of all quiz totalScore
  maxScoreSum       Int                    @default(0) // sum of all quiz maxScore
  completedQuizzes  Int                    @default(0)
  lastQuizAt        DateTime?              @db.Timestamp(0)
  leagueTier        LeagueTier             @default(IRON)
  leaguePoints      Int                    @default(0) // points internes pour montée/descente
  lastLeagueChange  DateTime?              @db.Timestamp(0)
  winningStreak     Int                    @default(0) // nombre de quiz gagnés consécutivement
  createdAt         DateTime               @default(now()) @db.Timestamp(0)
  updatedAt         DateTime               @default(now()) @updatedAt @db.Timestamp(0)
  user              User                   @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  job               Job?                   @relation(fields: [jobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  jobFamily         JobFamily?             @relation(fields: [jobFamilyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  selectedJobs      UserJobSelectedJob[]
  quizzes           UserQuiz[]
  competencies      UserJobCompetency[]
  learningResources LearningResource[]
  leagueHistories   UserJobLeagueHistory[]
  kiviats           UserJobKiviat[]
  userJobQuests     UserJobQuest[]
  userQuestGroups   UserQuestGroup[]

  @@unique([userId, jobId], map: "unique_user_job")
  @@unique([userId, jobFamilyId], map: "unique_user_job_family")
  @@index([userId], map: "idx_user_job_user")
  @@index([jobId], map: "idx_user_job_job")
  @@index([jobFamilyId], map: "idx_user_job_job_family")
  @@index([userId, status], map: "idx_user_job_user_status")
}

model UserJobCompetency {
  id              String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId       String                     @db.Uuid
  competencyId    String                     @db.Uuid
  // Stats globales pour ce couple (User, Job, Competency)
  currentScore    Float                      @default(0) // score actuel (pondéré ou moyenne)
  maxScore        Float                      @default(0) // max théorique cumulé
  percentage      Float                      @default(0) // currentScore / maxScore * 100
  attemptsCount   Int                        @default(0) // nombre de quiz qui ont alimenté cette compétence
  bestScore       Float                      @default(0) // meilleur score pour cette compétence
  lastQuizAt      DateTime?                  @db.Timestamp(0)
  // IRT (niveau latent)
  theta           Float                      @default(0)
  thetaVar        Float                      @default(1)
  thetaUpdatedAt  DateTime?                  @db.Timestamp(0)
  // HLR (rétention)
  halfLifeDays    Float                      @default(1)
  lastPracticedAt DateTime?                  @db.Timestamp(0)
  hlrUpdatedAt    DateTime?                  @db.Timestamp(0)
  // Maîtrise dérivée
  masteryNow      Float                      @default(0)
  mastery30d      Float                      @default(0)
  // Optionnel : niveau dérivé des scores (si tu veux mapper vers EASY/MEDIUM/HARD/EXPERT)
  level           Level?
  // Rating relatif au JobProgressionLevel (ex: JUNIOR -> TRES_BON, MIDLEVEL -> MOYEN)
  rating          CompetencyRating           @default(MOYEN)
  createdAt       DateTime                   @default(now()) @db.Timestamp(0)
  updatedAt       DateTime                   @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  userJob         UserJob                    @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  competency      Competency                 @relation(fields: [competencyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  histories       UserJobCompetencyHistory[]

  @@unique([userJobId, competencyId], map: "unique_user_job_competency")
  @@index([userJobId], map: "idx_ujc_user_job")
  @@index([competencyId], map: "idx_ujc_competency")
}

model UserJobCompetencyHistory {
  id                  String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobCompetencyId String            @db.Uuid
  userQuizId          String            @db.Uuid
  // Score pour CETTE compétence dans CE quiz précis
  score               Float             @default(0)
  maxScore            Float             @default(0)
  percentage          Float             @default(0)
  lagSecondsSincePrev Int?
  featuresSnapshot    Json?
  thetaBefore         Float?
  thetaAfter          Float?
  halfLifeBeforeDays  Float?
  halfLifeAfterDays   Float?
  // Optionnel : snapshot du niveau à ce moment là
  level               Level?
  // Snapshot du rating à ce moment là
  rating              CompetencyRating?
  createdAt           DateTime          @default(now()) @db.Timestamp(0)
  // Relations
  userJobCompetency   UserJobCompetency @relation(fields: [userJobCompetencyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userQuiz            UserQuiz          @relation(fields: [userQuizId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@index([userJobCompetencyId, createdAt], map: "idx_ujc_history_timeline")
  @@index([userQuizId], map: "idx_ujc_history_user_quiz")
}

model UserJobKiviat {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId            String                 @db.Uuid
  competenciesFamilyId String                 @db.Uuid
  rawScore0to10        Float                  @default(0)
  radarScore0to5       Float                  @default(0)
  continuous0to10      Float                  @default(0)
  masteryAvg0to1       Float                  @default(0)
  level                JobProgressionLevel?
  createdAt            DateTime               @default(now()) @db.Timestamp(0)
  updatedAt            DateTime               @default(now()) @updatedAt @db.Timestamp(0)
  userJob              UserJob                @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  competenciesFamily   CompetenciesFamily     @relation(fields: [competenciesFamilyId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  histories            UserJobKiviatHistory[]

  @@unique([userJobId, competenciesFamilyId], map: "unique_user_job_kiviat")
  @@index([userJobId], map: "idx_user_job_kiviat_user_job")
}

model UserJobKiviatHistory {
  id              String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobKiviatId String               @db.Uuid
  userQuizId      String               @db.Uuid
  rawScore0to10   Float
  radarScore0to5  Float
  continuous0to10 Float
  masteryAvg0to1  Float
  level           JobProgressionLevel?
  createdAt       DateTime             @default(now()) @db.Timestamp(0)
  userJobKiviat   UserJobKiviat        @relation(fields: [userJobKiviatId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userQuiz        UserQuiz             @relation(fields: [userQuizId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@index([userJobKiviatId, createdAt], map: "idx_user_job_kiviat_history")
  @@index([userQuizId], map: "idx_user_job_kiviat_history_quiz")
}

model UserJobLeagueHistory {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId   String      @db.Uuid
  fromTier    LeagueTier?
  toTier      LeagueTier
  deltaPoints Int         @default(0) // variation de leaguePoints
  reason      String?     @db.VarChar(255) // "QUIZ_WON", "QUIZ_LOST", "MANUAL_ADJUSTMENT", etc.
  createdAt   DateTime    @default(now()) @db.Timestamp(0)
  userJob     UserJob     @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@index([userJobId, createdAt], map: "idx_league_history_user_job")
}

model UserJobQuest {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId         String          @db.Uuid
  questDefinitionId String          @db.Uuid
  periodStartAt     DateTime        @db.Timestamp(0)
  periodEndAt       DateTime        @db.Timestamp(0)
  progressCount     Int             @default(0)
  status            QuestStatus     @default(ACTIVE)
  meta              Json?
  completedAt       DateTime?       @db.Timestamp(0)
  claimedAt         DateTime?       @db.Timestamp(0)
  createdAt         DateTime        @default(now()) @db.Timestamp(0)
  updatedAt         DateTime        @default(now()) @updatedAt @db.Timestamp(0)
  userJob           UserJob         @relation(fields: [userJobId], references: [id], onDelete: Cascade)
  questDefinition   QuestDefinition @relation(fields: [questDefinitionId], references: [id], onDelete: Cascade)

  @@unique([userJobId, questDefinitionId, periodStartAt])
  @@index([userJobId, status, periodStartAt])
}

model UserJobSelectedJob {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId  String   @db.Uuid
  jobId      String   @db.Uuid
  isSelected Boolean  @default(true)
  createdAt  DateTime @default(now()) @db.Timestamp(0)
  updatedAt  DateTime @default(now()) @updatedAt @db.Timestamp(0)
  userJob    UserJob  @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  job        Job      @relation(fields: [jobId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userJobId, jobId], map: "unique_user_job_selected_job")
  @@index([userJobId], map: "idx_user_job_selected_job_user_job")
  @@index([jobId], map: "idx_user_job_selected_job_job")
}

model UserLandingModule {
  id        String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String               @db.Uuid
  moduleId  String               @db.Uuid
  order     Int
  addedBy   LandingModuleAddedBy
  addedAt   DateTime             @default(now()) @db.Timestamp(0)
  removedAt DateTime?            @db.Timestamp(0)
  user      User                 @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  module    Module               @relation(fields: [moduleId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, moduleId], map: "unique_user_landing_module")
  @@index([userId], map: "idx_user_landing_module_user")
  @@index([moduleId], map: "idx_user_landing_module_module")
}

model UserLandingModuleEvent {
  id        String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String              @db.Uuid
  moduleId  String              @db.Uuid
  action    LandingModuleAction
  actor     LandingModuleActor
  createdAt DateTime            @default(now()) @db.Timestamp(0)
  metadata  Json?
  user      User                @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  module    Module              @relation(fields: [moduleId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@index([userId], map: "idx_user_landing_event_user")
  @@index([moduleId], map: "idx_user_landing_event_module")
  @@index([createdAt], map: "idx_user_landing_event_created_at")
}

model UserLearningResource {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String           @db.Uuid
  resourceId   String           @db.Uuid
  openedAt     DateTime?        @db.Timestamp(0)
  readAt       DateTime?        @db.Timestamp(0)
  lastViewedAt DateTime?        @db.Timestamp(0)
  isLikedAt    DateTime?        @db.Timestamp(0)
  viewsCount   Int              @default(0)
  progress     Float?
  metadata     Json?
  createdAt    DateTime         @default(now()) @db.Timestamp(0)
  updatedAt    DateTime         @default(now()) @updatedAt @db.Timestamp(0)
  user         User             @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  resource     LearningResource @relation(fields: [resourceId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, resourceId], map: "unique_user_learning_resource")
  @@index([userId], map: "idx_user_learning_resource_user")
  @@index([resourceId], map: "idx_user_learning_resource_resource")
  @@index([lastViewedAt], map: "idx_user_learning_resource_last_viewed_at")
}

model UserModule {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String           @db.Uuid
  moduleId  String           @db.Uuid
  status    UserModuleStatus @default(ACTIVE)
  createdAt DateTime         @default(now()) @db.Timestamp(0)
  updatedAt DateTime         @default(now()) @updatedAt @db.Timestamp(0)
  user      User             @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  module    Module           @relation(fields: [moduleId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, moduleId], map: "unique_user_module")
  @@index([userId], map: "idx_user_module_user")
  @@index([moduleId], map: "idx_user_module_module")
}

model UserQuest {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String          @db.Uuid
  questDefinitionId String          @db.Uuid
  status            QuestStatus     @default(ACTIVE)
  progressCount     Int             @default(0)
  periodStartAt     DateTime        @db.Timestamp(0)
  periodEndAt       DateTime        @db.Timestamp(0)
  completedAt       DateTime?       @db.Timestamp(0)
  claimedAt         DateTime?       @db.Timestamp(0)
  createdAt         DateTime        @default(now()) @db.Timestamp(0)
  updatedAt         DateTime        @default(now()) @updatedAt @db.Timestamp(0)
  user              User            @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  questDefinition   QuestDefinition @relation(fields: [questDefinitionId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, questDefinitionId, periodStartAt])
  @@index([userId])
  @@index([questDefinitionId])
}

model UserQuestGroup {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String      @db.Uuid
  userJobId         String?     @db.Uuid
  questGroupId      String      @db.Uuid
  status            QuestStatus @default(ACTIVE)
  requiredTotal     Int         @default(0)
  requiredCompleted Int         @default(0)
  optionalTotal     Int         @default(0)
  optionalCompleted Int         @default(0)
  periodStartAt     DateTime    @db.Timestamp(0)
  periodEndAt       DateTime    @db.Timestamp(0)
  completedAt       DateTime?   @db.Timestamp(0)
  claimedAt         DateTime?   @db.Timestamp(0)
  createdAt         DateTime    @default(now()) @db.Timestamp(0)
  updatedAt         DateTime    @default(now()) @updatedAt @db.Timestamp(0)
  user              User        @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  userJob           UserJob?    @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  questGroup        QuestGroup  @relation(fields: [questGroupId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@unique([userId, userJobId, questGroupId, periodStartAt])
  @@index([userId])
  @@index([userJobId])
  @@index([questGroupId])
}

model UserQuiz {
  id                  String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userJobId           String                     @db.Uuid
  quizId              String                     @db.Uuid // Quiz.id is String @default(uuid())
  type                QuizType                   @default(DAILY)
  isActive            Boolean                    @default(true)
  status              UserQuizStatus             @default(ASSIGNED)
  index               Int
  assignedAt          DateTime                   @default(now()) @db.Timestamp(0)
  startedAt           DateTime?                  @db.Timestamp(0)
  completedAt         DateTime?                  @db.Timestamp(0)
  totalScore          Int                        @default(0)
  bonusPoints         Int                        @default(0)
  maxScore            Int                        @default(0)
  maxScoreWithBonus   Int                        @default(0)
  percentage          Float?                     @default(0)
  jobsSnapshot        Json?                      @db.JsonB
  metadata            Json?
  createdAt           DateTime                   @default(now()) @db.Timestamp(0)
  updatedAt           DateTime                   @default(now()) @updatedAt @db.Timestamp(0)
  // Relations
  userJob             UserJob                    @relation(fields: [userJobId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  quiz                Quiz                       @relation(fields: [quizId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  answers             UserQuizAnswer[]
  competencyHistories UserJobCompetencyHistory[]
  kiviatHistories     UserJobKiviatHistory[]

  @@unique([userJobId, quizId], map: "unique_user_quiz_user_job_quiz")
  @@index([quizId], map: "idx_user_quiz_quiz")
  @@index([userJobId, status, type, assignedAt], map: "idx_user_quiz_core")
  @@index([userJobId, status, completedAt], map: "idx_user_quiz_completed_at")
}

model UserQuizAnswer {
  id             String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userQuizId     String                 @db.Uuid
  questionId     String                 @db.Uuid // QuizQuestion.id (String)
  timeToAnswer   Int
  freeTextAnswer String?
  isCorrect      Boolean                @default(false)
  score          Int?                   @default(0)
  createdAt      DateTime               @default(now()) @db.Timestamp(0)
  updatedAt      DateTime               @default(now()) @updatedAt @db.Timestamp(0)
  userQuiz       UserQuiz               @relation(fields: [userQuizId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  question       QuizQuestion           @relation(fields: [questionId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  options        UserQuizAnswerOption[]

  @@unique([userQuizId, questionId])
  @@index([userQuizId], map: "idx_user_quiz_answer_user_quiz")
  @@index([questionId], map: "idx_user_quiz_answer_question")
}

model UserQuizAnswerOption {
  userQuizAnswerId String         @db.Uuid
  responseId       String         @db.Uuid // QuizResponse.id
  // Relations
  answer           UserQuizAnswer @relation(fields: [userQuizAnswerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  response         QuizResponse   @relation(fields: [responseId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@id([userQuizAnswerId, responseId])
  @@index([responseId], map: "idx_user_quiz_answer_option_response")
}

model UserStreak {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String     @db.Uuid
  type           StreakType @default(LOGIN_DAILY)
  currentDays    Int        @default(0)
  bestDays       Int        @default(0)
  lastActiveDay  String?    @db.VarChar(10)
  streakStartDay String?    @db.VarChar(10)
  createdAt      DateTime   @default(now()) @db.Timestamp(0)
  updatedAt      DateTime   @default(now()) @updatedAt @db.Timestamp(0)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
}
